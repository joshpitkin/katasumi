// This is your Prisma schema file for the web app
// Minimal schema for authentication and sync

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Users table - stores user accounts for web app
model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  passwordHash          String    @map("password_hash")
  tier                  String    @default("free") // 'free' | 'pro' | 'enterprise'
  subscriptionStatus    String    @default("free") @map("subscription_status") // 'free' | 'premium' | 'enterprise'
  subscriptionExpiresAt DateTime? @map("subscription_expires_at")
  apiTokenHash          String?   @map("api_token_hash")
  aiKeyMode             String    @default("personal") @map("ai_key_mode") // 'personal' | 'builtin'
  
  // AI Configuration (for syncing to TUI)
  aiProvider            String?   @map("ai_provider") // 'openai' | 'anthropic' | 'openrouter' | etc.
  aiApiKeyEncrypted     String?   @map("ai_api_key_encrypted") // Encrypted API key
  aiModel               String?   @map("ai_model") // e.g., 'gpt-4', 'claude-3-opus'
  aiBaseUrl             String?   @map("ai_base_url") // Custom API endpoint
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  userShortcuts  UserShortcut[]
  collections    Collection[]
  syncLogs       SyncLog[]
  aiUsage        AiUsage[]
  
  @@index([email])
  @@index([tier])
  @@index([subscriptionStatus])
  @@map("users")
}

// UserShortcuts table - stores user-created shortcuts
model UserShortcut {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  app       String   // Application identifier (e.g., "vim", "vscode")
  action    String   // Action description (e.g., "Copy", "Paste")
  
  // Platform-specific keyboard shortcuts
  keysMac     String?  @map("keys_mac")
  keysWindows String?  @map("keys_windows")
  keysLinux   String?  @map("keys_linux")
  
  context   String?  // Context where shortcut applies (e.g., "Normal Mode", "Insert Mode")
  category  String?  // Category grouping (e.g., "Editing", "Navigation")
  tags      String   // Comma-separated tags for searching
  
  // Source metadata
  sourceType       String   @map("source_type") // 'official' | 'community' | 'ai-scraped' | 'user-added'
  sourceUrl        String?  @map("source_url")
  sourceScrapedAt  DateTime? @map("source_scraped_at")
  sourceConfidence Float?   @map("source_confidence")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  collectionItems  CollectionShortcut[]
  
  @@index([userId])
  @@index([app])
  @@index([action])
  @@index([category])
  @@map("user_shortcuts")
}

// Collections table - stores user-created collections of shortcuts
model Collection {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  shortcuts   CollectionShortcut[]
  
  @@index([userId])
  @@index([isPublic])
  @@map("collections")
}

// CollectionShortcuts junction table - links shortcuts to collections
model CollectionShortcut {
  id           String   @id @default(uuid())
  collectionId String   @map("collection_id")
  shortcutId   String   @map("shortcut_id")
  order        Int      @default(0) // For custom ordering within collection
  
  createdAt    DateTime @default(now()) @map("created_at")
  
  collection   Collection   @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  shortcut     UserShortcut @relation(fields: [shortcutId], references: [id], onDelete: Cascade)
  
  @@unique([collectionId, shortcutId])
  @@index([collectionId])
  @@index([shortcutId])
  @@map("collection_shortcuts")
}

// SyncLogs table - audit trail for sync operations
model SyncLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  operation String   // 'push' | 'pull' | 'merge'
  status    String   // 'success' | 'failed' | 'partial'
  details   String?  // JSON string with additional details
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@map("sync_logs")
}

// AiUsage table - tracks AI query usage for rate limiting
model AiUsage {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  query      String   // The search query that was made
  timestamp  DateTime @default(now())
  tokensUsed Int?     @map("tokens_used")
  queryType  String?  @map("query_type") // 'search' | 'general'
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@map("ai_usage")
}

// AppConfig table - stores encrypted application configuration
model AppConfig {
  id             String   @id @default(uuid())
  key            String   @unique // e.g., 'internal_ai_key'
  encryptedValue String   @map("encrypted_value")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  @@map("app_config")
}

// Subscriptions table - stores Stripe subscription data
// NOTE: For MVP, premium users can be created manually via database
// Stripe integration placeholder for future payment processing
model Subscription {
  id                   String    @id @default(uuid())
  userId               String    @unique @map("user_id")
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  status               String    @default("free") // 'free' | 'premium' | 'cancelled' | 'expired'
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")
  
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@map("subscriptions")
}
